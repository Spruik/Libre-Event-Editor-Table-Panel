{"version":3,"sources":["../src/edit_event_ctrl.js"],"names":["utils","instant","influx","SplitEventCtrl","EditEventCtrl","ctrl","init","prepare","showModal","panelCtrl","currentEvent","nextEvent","equipment","reasonCodes","currentReasons","editForm","category","record","reasons","comment","saveBtnMsg","meta","isSaving","datalist","map","x","text","indexOf","isValidVal","push","findReasonsByCategory","reason","split","i","length","children","findChildrenByReason","enableInstantSearch","event","target","innerHTML","key","index","newChildren","splice","pop","panel","measurementOK","alert","enableSaving","measurement","endPoint","result","insert","ok","closeForm","refresh","error","console","log","splitForm","show","filter","parentChildren","parent","child","disableSaving","setTimeout","document","querySelector","click"],"mappings":"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","file":"edit_event_ctrl.js","sourcesContent":["import * as utils from './utils'\nimport * as instant from './instant_search_ctrl'\nimport * as influx from './influxAPI'\n\nimport {SplitEventCtrl} from './split_event_form'\n\nexport class EditEventCtrl {\n  /** @ngInject */\n  constructor(ctrl) {\n    this.init(ctrl)\n    this.prepare()\n  } \n\n  show() {\n    utils.showModal('event_editor_form.html', this, 'confirm-modal event-editor-form-modal scroll')\n  }\n\n  init(ctrl) {\n    this.panelCtrl = ctrl.panelCtrl;\n    this.currentEvent = ctrl.currentEvent\n    this.nextEvent = ctrl.nextEvent\n    this.equipment = ctrl.equipment\n    this.reasonCodes = ctrl.reasonCodes\n    this.reasonCodes.currentReasons = []\n    this.editForm = { \n      category: this.currentEvent.record.category, \n      reasons: [], \n      equipment: null, \n      comment: this.currentEvent.record.comment,\n      saveBtnMsg: 'Save',\n      meta: {\n        isSaving: false\n      }\n    }\n\n    // if record's equipment can be found in the posrgres equipment list\n    if (this.equipment.datalist.map(x => x.text).indexOf(this.currentEvent.record.equipment) !== -1){\n      this.editForm.equipment = this.currentEvent.record.equipment\n    }\n  }\n\n  prepare() {\n    const record = this.currentEvent.record\n\n    // if there is category but not reason\n    if(utils.isValidVal(record.category)){\n      this.reasonCodes.currentReasons.push(this.findReasonsByCategory(record.category))\n      // if there is reasons\n      if (utils.isValidVal(record.reason)) {\n        this.editForm.reasons = record.reason.split(' | ')\n        const reasons = this.editForm.reasons\n        for (let i = 0; i < reasons.length; i++) {\n          const reason = reasons[i];\n          const children = this.findChildrenByReason(reason)\n          if(children.length !== 0) {\n            this.reasonCodes.currentReasons.push(children)\n          }\n        }\n      }\n    }\n\n  }\n\n  dataSearch() {\n    instant.enableInstantSearch(\n      this.equipment.datalist,\n      'eet-datalist-equipment',\n      'eet-datalist-input-equipment',\n      'eet-datalist-ul-equipment'\n    )\n  }\n\n  onDataSearchChange(event) {\n    this.editForm.equipment = event.target.innerHTML\n  }\n\n  onReasonSelect(key, index) {\n    const length = this.reasonCodes.currentReasons.length\n    const newChildren = this.findChildrenByReason(key)\n    this.reasonCodes.currentReasons.splice(index + 1, length - (index + 1), newChildren)\n    if (newChildren.length === 0) this.reasonCodes.currentReasons.pop()\n    this.editForm.reasons.length = index + 1\n  }\n\n  onCategorySelect(key) {\n    this.reasonCodes.currentReasons = []\n    this.editForm.reasons = []\n    this.reasonCodes.currentReasons.push(this.findReasonsByCategory(key))\n  }\n\n  async onSave() {\n    if(!this.panelCtrl.panel.measurementOK) {\n      utils.alert('warning', 'Warning', \"The measurement you put in the Down Time Panel may be invalid, please make sure it matches the one that's in the query\")\n      return\n    }\n\n    if (!this.editForm.category) {\n      utils.alert('warning', 'Warning', \"Please select a category\")\n      return\n    }\n\n    if(utils.isValidVal(this.editForm.equipment)) {\n      if (this.equipment.datalist.map(x => x.text).indexOf(this.editForm.equipment) === -1){\n        utils.alert('warning', 'Warning', `Cannot find equipment \"${this.editForm.equipment}\" in the database, please choose it from the list or just leave it empty`)\n        return\n      }\n    }\n\n    this.enableSaving()\n\n    const measurement = this.panelCtrl.panel.endPoint\n    const result = await influx.insert(measurement, this.currentEvent, this.editForm)\n\n    if(result.ok) {\n      utils.alert('success', 'Successful', `The event has been successfully updated`)\n      this.closeForm()\n      this.panelCtrl.refresh()\n    }else {\n      utils.alert('error', 'Error', `Unexpected error occurred when updating this event due to ${result.error}, please try again or contact the dev team`)\n      this.closeForm()\n      console.log(result.error)\n    }\n  }\n\n  onSplit() {\n    //check equipment\n    if(utils.isValidVal(this.editForm.equipment)) {\n      if (this.equipment.datalist.map(x => x.text).indexOf(this.editForm.equipment) === -1){\n        utils.alert('warning', 'Warning', `Cannot find equipment \"${this.editForm.equipment}\" in the database, please choose it from the list or just leave it empty`)\n        return\n      }\n    }\n    \n    const splitForm = new SplitEventCtrl(this)\n    splitForm.show()\n  }\n\n  findReasonsByCategory(key) {\n    return this.reasonCodes.reasons.filter(x => x.category === key).map(x => x.reason)\n  }\n\n  findChildrenByReason(key) {\n    const category = this.editForm.category\n    return this.reasonCodes.parentChildren.filter(x => x.category === category && x.parent === key).map(x => x.child)\n  }\n\n  enableSaving() {\n    this.editForm.meta.isSaving = true\n    this.editForm.saveBtnMsg = 'Saving... '\n  }\n\n  disableSaving() {\n    this.editForm.meta.isSaving = false\n    this.editForm.saveBtnMsg = 'Save'\n  }\n\n  closeForm() {\n    this.disableSaving()\n    setTimeout(() => {\n      document.querySelector('#eetp-edit-form-closeBtn').click()\n    }, 0);\n  }\n  \n}"]}