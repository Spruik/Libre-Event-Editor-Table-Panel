{"version":3,"sources":["../src/edit_event_ctrl.js"],"names":["utils","instant","influx","SplitEventCtrl","EditEventCtrl","ctrl","init","prepare","showModal","panelCtrl","currentEvent","equipment","reasonCodes","currentReasons","editForm","category","record","reasons","comment","saveBtnMsg","meta","isSaving","datalist","map","x","text","indexOf","isValidVal","push","findReasonsByCategory","reason","split","i","length","children","findChildrenByReason","enableInstantSearch","event","target","innerHTML","key","index","newChildren","splice","pop","panel","measurementOK","alert","enableSaving","measurement","endPoint","result","insert","ok","closeForm","refresh","error","console","log","splitForm","show","filter","parentChildren","parent","child","disableSaving","setTimeout","document","querySelector","click"],"mappings":"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","file":"edit_event_ctrl.js","sourcesContent":["import * as utils from './utils';\nimport * as instant from './instant_search_ctrl';\nimport * as influx from './influxAPI';\n\nimport { SplitEventCtrl } from './split_event_form';\n\nexport class EditEventCtrl {\n\t/** @ngInject */\n\tconstructor(ctrl) {\n\t\tthis.init(ctrl);\n\t\tthis.prepare();\n\t}\n\n\tshow() {\n\t\tutils.showModal('event_editor_form.html', this, 'confirm-modal event-editor-form-modal scroll');\n\t}\n\n\tinit(ctrl) {\n\t\tthis.panelCtrl = ctrl.panelCtrl;\n\t\tthis.currentEvent = ctrl.currentEvent;\n\t\tthis.equipment = ctrl.equipment;\n\t\tthis.reasonCodes = ctrl.reasonCodes;\n\t\tthis.reasonCodes.currentReasons = [];\n\t\tthis.editForm = {\n\t\t\tcategory: this.currentEvent.record.category,\n\t\t\treasons: [],\n\t\t\tequipment: null,\n\t\t\tcomment: this.currentEvent.record.comment,\n\t\t\tsaveBtnMsg: 'Save',\n\t\t\tmeta: {\n\t\t\t\tisSaving: false\n\t\t\t}\n\t\t};\n\n\t\t// if record's equipment can be found in the posrgres equipment list\n\t\tif (this.equipment.datalist.map((x) => x.text).indexOf(this.currentEvent.record.equipment) !== -1) {\n\t\t\tthis.editForm.equipment = this.currentEvent.record.equipment;\n\t\t}\n\t}\n\n\tprepare() {\n\t\tconst record = this.currentEvent.record;\n\t\t// if there is category but not reason\n\t\tif (utils.isValidVal(record.category)) {\n\t\t\tthis.reasonCodes.currentReasons.push(this.findReasonsByCategory(record.category));\n\t\t\t// if there is reasons\n\t\t\tif (utils.isValidVal(record.reason)) {\n\t\t\t\tthis.editForm.reasons = record.reason.split(' | ');\n\t\t\t\tconst reasons = this.editForm.reasons;\n\t\t\t\tfor (let i = 0; i < reasons.length; i++) {\n\t\t\t\t\tconst reason = reasons[i];\n\t\t\t\t\tconst children = this.findChildrenByReason(reason);\n\t\t\t\t\tif (children.length !== 0) {\n\t\t\t\t\t\tthis.reasonCodes.currentReasons.push(children);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tdataSearch() {\n\t\tinstant.enableInstantSearch(\n\t\t\tthis.equipment.datalist,\n\t\t\t'eet-datalist-equipment',\n\t\t\t'eet-datalist-input-equipment',\n\t\t\t'eet-datalist-ul-equipment'\n\t\t);\n\t}\n\n\tonDataSearchChange(event) {\n\t\tthis.editForm.equipment = event.target.innerHTML;\n\t}\n\n\tonReasonSelect(key, index) {\n\t\tconst length = this.reasonCodes.currentReasons.length;\n\t\tconst newChildren = this.findChildrenByReason(key);\n\t\tthis.reasonCodes.currentReasons.splice(index + 1, length - (index + 1), newChildren);\n\t\tif (newChildren.length === 0) this.reasonCodes.currentReasons.pop();\n\t\tthis.editForm.reasons.length = index + 1;\n\t}\n\n\tonCategorySelect(key) {\n\t\tthis.reasonCodes.currentReasons = [];\n\t\tthis.editForm.reasons = [];\n\t\tthis.reasonCodes.currentReasons.push(this.findReasonsByCategory(key));\n\t}\n\n\tasync onSave() {\n\t\tif (!this.panelCtrl.panel.measurementOK) {\n\t\t\tutils.alert(\n\t\t\t\t'warning',\n\t\t\t\t'Warning',\n\t\t\t\t\"The measurement you put in the Down Time Panel may be invalid, please make sure it matches the one that's in the query\"\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.editForm.category) {\n\t\t\tutils.alert('warning', 'Warning', 'Please select a category');\n\t\t\treturn;\n\t\t}\n\n\t\tif (utils.isValidVal(this.editForm.equipment)) {\n\t\t\tif (this.equipment.datalist.map((x) => x.text).indexOf(this.editForm.equipment) === -1) {\n\t\t\t\tutils.alert(\n\t\t\t\t\t'warning',\n\t\t\t\t\t'Warning',\n\t\t\t\t\t`Cannot find equipment \"${this.editForm\n\t\t\t\t\t\t.equipment}\" in the database, please choose it from the list or just leave it empty`\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tthis.enableSaving();\n\n\t\tconst measurement = this.panelCtrl.panel.endPoint;\n\t\tconst result = await influx.insert(measurement, this.currentEvent, this.editForm);\n\n\t\tif (result.ok) {\n\t\t\tutils.alert('success', 'Successful', `The event has been successfully updated`);\n\t\t\tthis.closeForm();\n\t\t\tthis.panelCtrl.refresh();\n\t\t} else {\n\t\t\tutils.alert(\n\t\t\t\t'error',\n\t\t\t\t'Error',\n\t\t\t\t`Unexpected error occurred when updating this event due to ${result.error}, please try again or contact the dev team`\n\t\t\t);\n\t\t\tthis.closeForm();\n\t\t\tconsole.log(result.error);\n\t\t}\n\t}\n\n\tonSplit() {\n\t\t//check equipment\n\t\tif (utils.isValidVal(this.editForm.equipment)) {\n\t\t\tif (this.equipment.datalist.map((x) => x.text).indexOf(this.editForm.equipment) === -1) {\n\t\t\t\tutils.alert(\n\t\t\t\t\t'warning',\n\t\t\t\t\t'Warning',\n\t\t\t\t\t`Cannot find equipment \"${this.editForm\n\t\t\t\t\t\t.equipment}\" in the database, please choose it from the list or just leave it empty`\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tconst splitForm = new SplitEventCtrl(this);\n\t\tsplitForm.show();\n\t}\n\n\tfindReasonsByCategory(key) {\n\t\treturn this.reasonCodes.reasons.filter((x) => x.category === key).map((x) => x.reason);\n\t}\n\n\tfindChildrenByReason(key) {\n\t\tconst category = this.editForm.category;\n\t\treturn this.reasonCodes.parentChildren\n\t\t\t.filter((x) => x.category === category && x.parent === key)\n\t\t\t.map((x) => x.child);\n\t}\n\n\tenableSaving() {\n\t\tthis.editForm.meta.isSaving = true;\n\t\tthis.editForm.saveBtnMsg = 'Saving... ';\n\t}\n\n\tdisableSaving() {\n\t\tthis.editForm.meta.isSaving = false;\n\t\tthis.editForm.saveBtnMsg = 'Save';\n\t}\n\n\tcloseForm() {\n\t\tthis.disableSaving();\n\t\tsetTimeout(() => {\n\t\t\tdocument.querySelector('#eetp-edit-form-closeBtn').click();\n\t\t}, 0);\n\t}\n}\n"]}