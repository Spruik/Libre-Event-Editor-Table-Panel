{"version":3,"sources":["../src/form_option_ctrl.js"],"names":["utils","EditEventCtrl","MaintenanceCtrl","FormOptionCtrl","ctrl","timestamp","panelCtrl","currentEvent","nextEvent","record","equipment","data","datalist","reasonCodes","categories","reasons","parentChildren","hasQueryData","showModal","measurement","panel","endPoint","influxUrl","influxHost","measurementResult","sure","get","isResultOK","isMeasureDataOK","parseData","equipmentEndPoint","equipmentUrl","postgRestHost","line","equipmentResult","reduce","arr","equip","obj","value","text","production_line","push","reasonCodeEndPoint","reasonCodeUrl","resonCodeResult","parseReasonCodes","allCategories","map","x","category_id","Array","from","Set","filter","reason_id","parent_reason_id","category","reason","parent","child","res","series","results","cols","columns","toLowerCase","rows","values","i","length","row","k","result","source","ok","alert","console","log","error","show","isValidVal"],"mappings":"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","file":"form_option_ctrl.js","sourcesContent":["import * as utils from './utils'\nimport {EditEventCtrl} from './edit_event_ctrl'\nimport {MaintenanceCtrl} from './maintenance_ctrl'\n\nexport class FormOptionCtrl {\n  /** @ngInject */\n  constructor(ctrl, timestamp) {\n    this.panelCtrl = ctrl;\n    this.currentEvent = { timestamp }\n    this.nextEvent = { record: null }\n    this.equipment = { data: null, datalist: null }\n    this.reasonCodes = { data: null, categories: null, reasons: null, parentChildren: null}\n  }\n\n  async show() {\n    const hasQueryData = await this.hasQueryData()\n    if (!hasQueryData) { return }\n    utils.showModal('form_option_form.html', this, 'editOrMaintenance-modal')\n  }\n\n  async hasQueryData() {\n    const measurement = this.panelCtrl.panel.endPoint\n    const timestamp = this.currentEvent.timestamp\n    const influxUrl = utils.influxHost + `query?pretty=true&db=smart_factory&q=select * from ${measurement} where time >= ${timestamp} limit 2`\n    const measurementResult = await utils.sure(utils.get(influxUrl))\n    if (!this.isResultOK(measurementResult, `influxdb - ${measurement}`)) { return false }\n    if (!this.isMeasureDataOK(measurementResult, `influxdb - ${measurement}`)) { return false }\n    this.parseData(measurementResult) // make results more structured, and store into cur and next\n\n    const equipmentEndPoint = this.panelCtrl.panel.equipmentEndPoint\n    const equipmentUrl = utils.postgRestHost + `${equipmentEndPoint}?production_line=eq.${this.currentEvent.record.line}&equipment=not.is.null`\n    const equipmentResult = await utils.sure(utils.get(equipmentUrl))\n    if (!this.isResultOK(equipmentResult, `postgresDB - ${equipmentEndPoint}`)) { return false }\n    this.equipment.data = equipmentResult.data\n    this.equipment.datalist = this.equipment.data.reduce((arr, equip) => {\n      const obj = {value: equip, text: equip.production_line + ' | ' + equip.equipment}\n      arr.push(obj)\n      return arr\n    }, [])\n\n    const reasonCodeEndPoint = this.panelCtrl.panel.reasonCodeEndPoint\n    const reasonCodeUrl = utils.postgRestHost + reasonCodeEndPoint\n    const resonCodeResult = await utils.sure(utils.get(reasonCodeUrl))\n    if (!this.isResultOK(resonCodeResult, `postgresDB - ${reasonCodeEndPoint}`)) { return false }\n    this.parseReasonCodes(resonCodeResult.data)\n\n    return true\n  }\n\n  parseReasonCodes(data) {\n    this.reasonCodes.data = data\n    const allCategories = data.map(x => x.category_id)\n    const categories = Array.from(new Set(allCategories))\n    this.reasonCodes.categories = categories\n    this.reasonCodes.reasons = data.filter(x => x.reason_id && !x.parent_reason_id).map(x => {\n      return {\n        category: x.category_id,\n        reason: x.reason_id\n      }\n    })\n    this.reasonCodes.parentChildren = data.filter(x => x.parent_reason_id).map(x => {\n      return {\n        category: x.category_id,\n        parent: x.parent_reason_id,\n        child: x.reason_id\n      }\n    })\n  }\n\n  parseData(res) {\n    const series = res.data.results[0].series[0]\n    const cols = series.columns.map(x => x.toLowerCase())\n    const rows = series.values\n    let data = []\n    for (let i = 0; i < rows.length; i++) {\n      let row = {}\n      for (let k = 0; k < cols.length; k++) {\n        row[cols[k]] = rows[i][k]\n      }\n      data.push(row)\n    }\n    \n    this.currentEvent.record = data[0]\n    this.nextEvent.record = data[1] || null\n  }\n\n  isResultOK(result, source) {\n    if (!result.ok){\n      utils.alert('error', 'Error', `Unexpected error occurred whiling getting data from ${source}, please try again`)\n      console.log(result.error)\n      return false\n    }else {\n      return true\n    }\n  }\n\n  isMeasureDataOK(result, source) {\n    if (!result.data.results[0].series) {\n      utils.alert('error', 'Error', `${source} is OK but returns EMPTY result, please make sure the data config measurement matches the one you put in the query and try again`)\n      return false\n    }\n    return true\n  }\n\n  onEditClick() {\n    new EditEventCtrl(this).show()\n  }\n\n  onMaintainClick() {\n    if(utils.isValidVal(this.currentEvent.record.category)) {\n      new MaintenanceCtrl(this).show()\n    } else {\n      utils.alert('error', 'Warning', 'Requesting maintenance requires the Event Category to be specified')\n      new EditEventCtrl(this).show()\n    }\n  }\n}"]}