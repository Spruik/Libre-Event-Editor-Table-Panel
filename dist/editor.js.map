{"version":3,"sources":["../src/editor.js"],"names":["tablePanelEditor","$q","uiSegmentSrv","restrict","scope","templateUrl","controller","TablePanelEditorCtrl","_","transformers","utils","$scope","editor","panelCtrl","ctrl","panel","fontSizes","addColumnSegment","newPlusButton","updateTransformHints","canSetColumns","columnsHelpMessage","transform","dataRaw","when","columns","getColumns","segments","map","c","newSegment","value","text","column","find","push","render","plusButton","html","key","influxUrl","influxHost","get","then","res","results","series","measurementOK","alert","includes","catch","without"],"mappings":"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","file":"editor.js","sourcesContent":["import _ from 'lodash';\nimport { transformers } from './transformers';\nimport * as utils from './utils'\n\nexport class TablePanelEditorCtrl {\n\n  /** @ngInject */\n  constructor($scope, $q, uiSegmentSrv) {\n    $scope.editor = this;\n    this.panelCtrl = $scope.ctrl;\n    this.panel = this.panelCtrl.panel;\n    this.transformers = transformers;\n    this.fontSizes = ['80%', '90%', '100%', '110%', '120%', '130%', '150%', '160%', '180%', '200%', '220%', '250%'];\n    this.addColumnSegment = uiSegmentSrv.newPlusButton();\n    this.updateTransformHints();\n  }\n\n  updateTransformHints() {\n    this.canSetColumns = false;\n    this.columnsHelpMessage = '';\n\n    switch (this.panel.transform) {\n      case 'timeseries_aggregations': {\n        this.canSetColumns = true;\n        break;\n      }\n      case 'json': {\n        this.canSetColumns = true;\n        break;\n      }\n      case 'table': {\n        this.columnsHelpMessage = 'Columns and their order are determined by the data query';\n      }\n    }\n  }\n\n  getColumnOptions() {\n    if (!this.panelCtrl.dataRaw) {\n      return this.$q.when([]);\n    }\n    const columns = this.transformers[this.panel.transform].getColumns(this.panelCtrl.dataRaw);\n    const segments = _.map(columns, (c) => this.uiSegmentSrv.newSegment({ value: c.text }));\n    return this.$q.when(segments);\n  }\n\n  addColumn() {\n    const columns = transformers[this.panel.transform].getColumns(this.panelCtrl.dataRaw);\n    const column = _.find(columns, { text: this.addColumnSegment.value });\n\n    if (column) {\n      this.panel.columns.push(column);\n      this.render();\n    }\n\n    const plusButton = this.uiSegmentSrv.newPlusButton();\n    this.addColumnSegment.html = plusButton.html;\n    this.addColumnSegment.value = plusButton.value;\n  }\n\n  transformChanged() {\n    this.panel.columns = [];\n    if (this.panel.transform === 'timeseries_aggregations') {\n      this.panel.columns.push({ text: 'Avg', value: 'avg' });\n    }\n\n    this.updateTransformHints();\n    this.render();\n  }\n\n  render() {\n    this.panelCtrl.render();\n  }\n\n  checkEndPoint(key){\n    let influxUrl = utils.influxHost + `query?pretty=true&db=smart_factory&q=select * from ${key}`\n    utils.get(influxUrl).then(res => {\n      if(!res.results[0].series){\n        this.panelCtrl.measurementOK = false\n        utils.alert('error', 'Error', \"The measurement you put in the Down Time Panel may be invalid, please make sure it matches the one that's in the query\")\n        return\n      } \n      if(!res.results[0].series[0].columns.includes('parentReason')){\n        this.panelCtrl.measurementOK = false\n        utils.alert('error', 'Error', \"The measurement you put in the Down Time Panel may be invalid, please make sure it matches the one that's in the query\")\n        return\n      }\n      utils.alert('success', 'Success', \"The measurement you put in has been tested and it's a valid measurement\")\n      this.panelCtrl.measurementOK = true\n    }).catch(() => {\n      this.panelCtrl.measurementOK = false\n      utils.alert('error', 'Error', \"The measurement you put in the Down Time Panel may be invalid, please make sure it matches the one that's in the query\")\n      return\n    })\n  }\n\n  removeColumn(column) {\n    this.panel.columns = _.without(this.panel.columns, column);\n    this.panelCtrl.render();\n  }\n}\n\n/** @ngInject */\nexport function tablePanelEditor($q, uiSegmentSrv) {\n  'use strict';\n  return {\n    restrict: 'E',\n    scope: true,\n    templateUrl: 'public/plugins/smart-factory-event-editor-table-panel/partials/editor.html',\n    controller: TablePanelEditorCtrl,\n  };\n}\n"]}